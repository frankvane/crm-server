{
    "sourceFile": "seeders/20240320000000-init.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1745937687428,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1745937793157,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,9 +2,9 @@\n \r\n module.exports = {\r\n   up: async (queryInterface, Sequelize) => {\r\n     // 创建权限\r\n-    const permissions = await queryInterface.bulkInsert(\r\n+    await queryInterface.bulkInsert(\r\n       \"Permissions\",\r\n       [\r\n         {\r\n           name: \"create_user\",\r\n@@ -53,14 +53,19 @@\n           description: \"查看角色列表\",\r\n           createdAt: new Date(),\r\n           updatedAt: new Date(),\r\n         },\r\n-      ],\r\n-      { returning: true }\r\n+      ]\r\n     );\r\n \r\n+    // 获取所有权限\r\n+    const permissions = await queryInterface.sequelize.query(\r\n+      \"SELECT id, name FROM Permissions\",\r\n+      { type: queryInterface.sequelize.QueryTypes.SELECT }\r\n+    );\r\n+\r\n     // 创建角色\r\n-    const roles = await queryInterface.bulkInsert(\r\n+    await queryInterface.bulkInsert(\r\n       \"Roles\",\r\n       [\r\n         {\r\n           name: \"admin\",\r\n@@ -73,14 +78,21 @@\n           description: \"普通用户\",\r\n           createdAt: new Date(),\r\n           updatedAt: new Date(),\r\n         },\r\n-      ],\r\n-      { returning: true }\r\n+      ]\r\n     );\r\n \r\n+    // 获取管理员角色\r\n+    const [adminRole] = await queryInterface.sequelize.query(\r\n+      \"SELECT id FROM Roles WHERE name = ?\",\r\n+      {\r\n+        replacements: [\"admin\"],\r\n+        type: queryInterface.sequelize.QueryTypes.SELECT,\r\n+      }\r\n+    );\r\n+\r\n     // 为角色分配权限\r\n-    const [adminRole] = roles;\r\n     const rolePermissions = permissions.map((permission) => ({\r\n       roleId: adminRole.id,\r\n       permissionId: permission.id,\r\n       createdAt: new Date(),\r\n@@ -89,9 +101,9 @@\n \r\n     await queryInterface.bulkInsert(\"RolePermissions\", rolePermissions);\r\n \r\n     // 创建管理员用户\r\n-    const adminUser = await queryInterface.bulkInsert(\r\n+    await queryInterface.bulkInsert(\r\n       \"Users\",\r\n       [\r\n         {\r\n           username: \"admin\",\r\n@@ -100,16 +112,24 @@\n           email: \"admin@example.com\",\r\n           createdAt: new Date(),\r\n           updatedAt: new Date(),\r\n         },\r\n-      ],\r\n-      { returning: true }\r\n+      ]\r\n     );\r\n \r\n+    // 获取管理员用户\r\n+    const [adminUser] = await queryInterface.sequelize.query(\r\n+      \"SELECT id FROM Users WHERE username = ?\",\r\n+      {\r\n+        replacements: [\"admin\"],\r\n+        type: queryInterface.sequelize.QueryTypes.SELECT,\r\n+      }\r\n+    );\r\n+\r\n     // 为管理员用户分配角色\r\n     await queryInterface.bulkInsert(\"UserRoles\", [\r\n       {\r\n-        userId: adminUser[0].id,\r\n+        userId: adminUser.id,\r\n         roleId: adminRole.id,\r\n         createdAt: new Date(),\r\n         updatedAt: new Date(),\r\n       },\r\n"
                }
            ],
            "date": 1745937687428,
            "name": "Commit-0",
            "content": "'use strict';\r\n\r\nmodule.exports = {\r\n  up: async (queryInterface, Sequelize) => {\r\n    // 创建权限\r\n    const permissions = await queryInterface.bulkInsert(\r\n      'Permissions',\r\n      [\r\n        {\r\n          name: 'create_user',\r\n          action: 'create',\r\n          resource: 'user',\r\n          description: '创建用户',\r\n          createdAt: new Date(),\r\n          updatedAt: new Date()\r\n        },\r\n        {\r\n          name: 'view_users',\r\n          action: 'read',\r\n          resource: 'user',\r\n          description: '查看用户列表',\r\n          createdAt: new Date(),\r\n          updatedAt: new Date()\r\n        },\r\n        {\r\n          name: 'update_user',\r\n          action: 'update',\r\n          resource: 'user',\r\n          description: '更新用户',\r\n          createdAt: new Date(),\r\n          updatedAt: new Date()\r\n        },\r\n        {\r\n          name: 'delete_user',\r\n          action: 'delete',\r\n          resource: 'user',\r\n          description: '删除用户',\r\n          createdAt: new Date(),\r\n          updatedAt: new Date()\r\n        },\r\n        {\r\n          name: 'manage_roles',\r\n          action: 'manage',\r\n          resource: 'role',\r\n          description: '管理角色',\r\n          createdAt: new Date(),\r\n          updatedAt: new Date()\r\n        },\r\n        {\r\n          name: 'view_roles',\r\n          action: 'read',\r\n          resource: 'role',\r\n          description: '查看角色列表',\r\n          createdAt: new Date(),\r\n          updatedAt: new Date()\r\n        }\r\n      ],\r\n      { returning: true }\r\n    );\r\n\r\n    // 创建角色\r\n    const roles = await queryInterface.bulkInsert(\r\n      'Roles',\r\n      [\r\n        {\r\n          name: 'admin',\r\n          description: '系统管理员',\r\n          createdAt: new Date(),\r\n          updatedAt: new Date()\r\n        },\r\n        {\r\n          name: 'user',\r\n          description: '普通用户',\r\n          createdAt: new Date(),\r\n          updatedAt: new Date()\r\n        }\r\n      ],\r\n      { returning: true }\r\n    );\r\n\r\n    // 为角色分配权限\r\n    const [adminRole] = roles;\r\n    const rolePermissions = permissions.map(permission => ({\r\n      roleId: adminRole.id,\r\n      permissionId: permission.id,\r\n      createdAt: new Date(),\r\n      updatedAt: new Date()\r\n    }));\r\n\r\n    await queryInterface.bulkInsert('RolePermissions', rolePermissions);\r\n\r\n    // 创建管理员用户\r\n    const adminUser = await queryInterface.bulkInsert(\r\n      'Users',\r\n      [\r\n        {\r\n          username: 'admin',\r\n          password: '$2b$10$YfgVXDGpIEUHwqLAUVvUxOK9r0l/6QJ.pwQE/XRHlj9KVyaW7LtDi', // 密码: admin123\r\n          email: 'admin@example.com',\r\n          createdAt: new Date(),\r\n          updatedAt: new Date()\r\n        }\r\n      ],\r\n      { returning: true }\r\n    );\r\n\r\n    // 为管理员用户分配角色\r\n    await queryInterface.bulkInsert('UserRoles', [\r\n      {\r\n        userId: adminUser[0].id,\r\n        roleId: adminRole.id,\r\n        createdAt: new Date(),\r\n        updatedAt: new Date()\r\n      }\r\n    ]);\r\n  },\r\n\r\n  down: async (queryInterface, Sequelize) => {\r\n    await queryInterface.bulkDelete('UserRoles', null, {});\r\n    await queryInterface.bulkDelete('RolePermissions', null, {});\r\n    await queryInterface.bulkDelete('Users', null, {});\r\n    await queryInterface.bulkDelete('Roles', null, {});\r\n    await queryInterface.bulkDelete('Permissions', null, {});\r\n  }\r\n}; "
        }
    ]
}