# 更新日志（Changelog）

所有显著更改都将记录在此文件中。格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)。

## 2024-06-10

- fix: 权限（permissions）内容已自动修正为与 seeders-old/init.js 完全一致，所有 code、name、描述、actionId、resourceId 字段均与老系统同步，确保权限点无遗漏、无差异。
- fix: 权限生成逻辑已自动遍历所有 resource_action，动态生成所有权限。

## 生成 gitlog.txt

```bash
git log --pretty=format:"%h|%cd|%s" --date=short --reverse > gitlog.txt && type gitlog.txt
```

---

## [2025-05-02]

### 新增

- 添加角色状态切换功能，支持启用/禁用角色
- 添加角色表 status 字段的数据库迁移

### 修复

- 修复用户删除操作时的外键约束问题，添加事务支持确保数据一致性
- 优化用户删除流程，先清理关联数据再删除用户记录
- 修复角色控制器中 sequelize 导入错误
- 修复初始化脚本中角色创建缺少 status 字段的问题

### 优化/重构

- 优化用户状态切换功能，添加事务支持确保数据一致性
- 增强用户状态切换接口，同时支持 PUT 和 PATCH 方法

### 优化/重构

- 优化用户状态切换功能，添加事务支持确保数据一致性

---

## [2025-05-01]

### 新增

- 拆分接口文档到 docs 目录，更新日志抽离到 UPDATE.md
- 创建了模型关联别名命名规范文档，提供了一致性命名标准
- 添加了路由权限验证的规范实现

### 优化/重构

- 修复资源操作和资源管理相关功能
- 优化权限验证中间件，确保一致的别名使用
- 统一路由中的权限格式，使其与数据库中的实际权限名称匹配
- 改进资源控制器，自动处理 meta 字段的 JSON 序列化与反序列化
- 修复 category 和 categoryType 路由中的权限验证问题

### 修复

- 修复用户列表和其他 API 的 403 无权限问题，调整权限名称格式
- 修复资源操作创建时的"Resource not found"错误
- 修复路由权限验证不一致的问题，统一使用正确的权限名称

---

## [2025-04-30]

### 新增

- 添加资源操作模型定义、资源与资源操作的控制器和路由
- 补全资源与资源操作相关权限，并确保超级管理员拥有全部权限
- 补全所有常用权限 seed，包括分类管理相关权限，并确保超级管理员拥有全部权限
- 新增获取单个分类接口及文档说明
- 新增 manager 和 user 用户，并分配对应角色权限
- 自动补全按钮级权限（ResourceActions）和菜单可见性（RoleResources），并分配给三类角色
- 添加用户角色关联表、角色资源关联表、资源表迁移文件
- 按 user-resource.md 精简初始数据，仅保留 admin/manager/user 三角色及核心权限资源
- 添加用户管理相关的权限和菜单资源
- 添加用户控制器的接口测试
- 完善初始化数据，添加教学管理相关权限和菜单

### 优化/重构

- 统一模型文件命名，将 user.js 重命名为 user.model.js
- 统一模型关联别名，将 Roles/Permissions 改为小写形式
- 统一用户状态为数字类型，修正关联表名称，添加角色管理权限
- 统一使用复数形式的关联表名
- 统一 as 别名为 Permissions，修复角色权限关联 EagerLoadingError
- 将 init.js 修改为标准的 Sequelize 种子文件格式
- 重构测试代码，改为纯接口测试
- 修改数据库清理函数以适配 SQL Server
- 修改用户列表接口返回格式，添加分页信息和用户状态
- 修改角色权限分配方法，使用 setPermissions 替代 addPermissions
- Role 模型补充与 Resource 的多对多关联，支持 setResources 菜单可见性分配
- 修复模型加载顺序，解决 CategoryType.hasMany 报错
- 修复模型关联中的列名冲突、别名大小写不一致问题
- 修复用户模型和初始化脚本中的密码加密逻辑，移除手动密码加密，使用模型钩子
- 修复初始化脚本中管理员用户的状态值为数字类型、密码加密问题
- 修正 JWT 工具使用的配置结构
- 清理测试文件并更新配置
- 移除学生管理相关的权限、资源和角色，仅保留核心数据资源

### 修复

- 修改 Resource 模型的 meta 字段类型为 TEXT 以支持 SQL Server
- 修复关联别名大小写不一致的问题
- 修复测试环境配置，移除数据库相关操作

### 文档

- 完善资源与权限相关接口文档，补全权限列表
- 补全 category 与 categoryType 接口文档
- 分类接口文档补全，增加获取单个分类接口说明
- 完善分类列表和分类树接口文档，明确 typeId 查询参数为必填项
- 阶段性成功版本，接口与文档同步完善

---

## [2025-04-29]

### 新增

- 项目初始化，添加 RBAC 权限管理、JWT 认证、无限级分类等基础模块
- 添加用户管理模块，实现 CRUD 接口和初始化脚本
- 添加分类类型管理，优化分类模型
- 添加默认分类数据
- 添加认证和权限中间件，实现分类类型管理接口
- 添加错误处理中间件
- 添加认证模块，修复路由错误
- 完善权限验证中间件，实现 verifyToken 和 hasPermission 功能
- 完善分类控制器实现，添加缺失方法和错误处理
- 添加角色管理模块，包括增删改查功能和 API 文档
- 完成项目基础功能开发，包括 RBAC 权限管理、JWT 认证和分类管理

### 优化/重构

- 优化 RBAC 权限管理模块，修复数据库同步问题
- 统一接口响应格式，完善错误处理
- 统一认证接口响应格式
- 修复用户路由中 rbac 中间件的使用方式
- 修复用户路由中间件问题，统一权限检查写法
- 修复分类路由中间件问题，完善权限控制
- 修复分类类型路由中间件问题，统一权限检查写法
- 修复应用中间件配置问题
- 修复模型关联查询中的别名问题
- 修复角色-权限关联查询中的别名问题
- 修复用户模块
- 修复角色路由中的权限检查中间件函数名错误
- 修复角色控制器中的响应格式，使用 ResponseUtil 类
- 修改角色控制器的导出方式，使用对象导出
- 修改角色路由中的中间件使用方式
- 重新整理更新日志，优化版本记录
- 采用 Keep a Changelog 格式重构更新日志

### 文档

- 添加详细的 API 接口文档
- 更新 README.md，添加分类管理 API 文档
- 更新 README.md，完善分类类型接口文档
- 更新分类树 API 文档，完善接口格式和错误响应说明
- 添加数据库初始化和种子数据的操作说明

---

## [2024-03-20]

### 新增

- **分类管理模块**
  - 分类类型的增删改查功能
  - 无限级分类结构的实现
  - 分类树形结构的查询接口
  - 分类代码唯一性校验机制

### 优化

- **数据库配置**
  - 优化 SQL Server 连接参数配置
  - 添加数据库连接重试机制
  - 设置连接超时处理
  - 完善数据库错误处理

### 文档

- 新增分类管理模块的 API 文档
- 添加数据库初始化和重置指南
- 完善环境配置说明文档

## [2024-03-19]

### 新增

- **RBAC 权限管理**
  - 用户管理的完整 CRUD 接口
  - 角色管理的完整 CRUD 接口
  - 权限管理和权限检查机制
  - 用户-角色-权限关联管理
- **JWT 认证系统**
  - 实现双 Token 认证机制
  - Access Token 的签发与验证
  - Refresh Token 的管理
  - Token 黑名单功能

### 优化

- **数据库功能**
  - 完成所有数据模型设计
  - 实现数据库自动同步机制
  - 添加初始化数据脚本
  - 优化数据查询性能

### 文档

- 编写详细的 API 接口文档
- 添加 RBAC 权限管理说明
- 完善项目目录结构说明

## [2024-03-18]

### 新增

- **项目框架**
  - 集成 Express.js 框架
  - 配置 Sequelize ORM
  - 添加必要的中间件
  - 设置基础路由结构

### 优化

- **开发环境**
  - 配置 ESLint 和 Prettier
  - 设置 Git 提交规范
  - 添加开发调试配置
  - 优化项目结构

### 文档

- 添加开发环境配置说明
- 编写代码规范文档
- 更新项目依赖说明

## [2024-03-17]

### 初始化

- 创建基础项目结构
- 初始化 package.json
- 添加核心依赖包
- 配置基本开发环境
- 初始化 Git 仓库

### 文档

- 创建基础 README 文件
- 添加项目描述
- 添加安装说明

## [2025-05-07]

- fix: 修复分片存储命名规则，严格使用 index 字段，解决合并时报分片不存在和合并后文件为 0KB 的问题。
- feat: 分片上传接口兼容前端 index 字段为 chunk_index，user_id 缺失时自动填充默认值，前端无需改动即可上传。
- refactor: file.controller.js 所有方法重构，所有参数严格以前端为准，字段名、校验、返回格式全部统一。
